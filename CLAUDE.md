# CLAUDE.md - Chameleon Integration

This file provides guidance to Claude Code when working with the Chameleon custom Home Assistant integration.

## Project Overview

**Chameleon** is a custom Home Assistant integration that extracts colors from images and applies them to RGB lights. It creates select entities (Adaptive Lighting style) that allow users to choose scenes from a directory of images, with support for both static color application and animated color cycling.

## Architecture

### Inspiration
This integration is inspired by:
- **scenery** - For select entity pattern and UI integration
- **adaptive_lighting** - For multi-instance config flow and entity creation pattern
- **color_extractor** - For the color extraction concept (but implemented internally)

### Key Design Decisions

**1. Select Entities (Not Input Selects)**
- Integration creates `select.{light_name}_scene` entities
- Options auto-populated by scanning image directory
- Native HA UI integration (dropdown in more-info dialog)
- No manual YAML configuration needed

**2. Hardcoded Image Directory**
```
/config/www/chameleon/
```
- Users drop images here
- Integration auto-discovers *.jpg, *.png files
- Converts filenames to scene names (e.g., `sunset_vibes.jpg` → "Sunset Vibes")
- No path configuration needed (simplifies UX for non-Docker users)

**3. Two Modes**
- **Static Mode**: Extract colors once, apply to light
- **Animation Mode**: Continuously cycle through color palette from image

**4. Multi-Light Support**
- One integration instance per light (Adaptive Lighting pattern)
- OR configure multiple lights in single instance (distribute colors across palette)
- Each light gets its own select entity

**5. Database Write Optimization**
- Use recorder exclusion for animation lights (documented in README)
- Use light transitions (not discrete updates) for smooth animation
- Configurable animation speed (default: 5-10 seconds per color)
- Avoid high-frequency updates that kill SD cards

## File Structure

```
custom_components/chameleon/
├── __init__.py              # Integration setup, entry point
├── manifest.json            # Integration metadata, dependencies
├── config_flow.py           # UI configuration flow
├── const.py                 # Constants (domain, defaults, etc.)
├── select.py                # Select entity platform
├── color_extractor.py       # Color extraction logic (PIL/Pillow)
├── animations.py            # Animation loop and color gradient generation
├── services.yaml            # Service definitions
├── strings.json             # UI translations
└── translations/
    └── en.json              # English translations
```

## Development Workflow

### Local Development
```bash
# On local machine
cd ~/projects/image-scene-colorizer
code .

# Edit code in custom_components/chameleon/

# Run local HA dev container for testing
docker run -d --name ha-dev -p 8123:8123 \
  -v ~/ha-dev-config:/config \
  -v ~/projects/image-scene-colorizer/custom_components:/config/custom_components \
  ghcr.io/home-assistant/home-assistant:stable
```

### Sync to Production
```bash
# From local machine, sync to production HA server
rsync -avz --delete \
  ~/projects/image-scene-colorizer/custom_components/chameleon/ \
  homelab:/config/custom_components/chameleon/

# Restart production HA
ssh homelab "docker restart homeassistant"
```

### Testing Workflow
1. Develop and test locally with dummy light entities
2. Sync to production via rsync when feature works
3. Test on production with real Hue/RGB lights
4. Iterate as needed

## Color Extraction Strategy

### Libraries
- **Primary**: Pillow (PIL) - Core image processing
- **Color Extraction**: colorthief or custom k-means clustering
- **Alternatives considered**: colorz (Rust, not usable), haishoku (Python, viable)

### Animation Color Strategy
**Don't just use dominant colors** - they won't look good for smooth animation.

**Recommended Approach: Color Gradient Paths**
1. Extract 5-10 colors from image using palette extraction
2. Create smooth gradients between each color pair
3. Result: 50-100 color progression for smooth animation
4. Cycle through this gradient path

**Alternative: Spatial Sampling**
- Sample colors from different regions of image (grid-based)
- Left, center, right regions for spatial distribution
- Use for multi-light setups (different lights get different regions)

## Select Entity Implementation

### Entity Creation
- Created during integration setup (config flow)
- Linked to target light entity
- Named: `select.{light_base_name}_scene`

### Dynamic Options
```python
# Options are auto-generated by scanning directory
def get_scene_options():
    image_dir = Path("/config/www/chameleon")
    images = list(image_dir.glob("*.jpg")) + list(image_dir.glob("*.png"))
    return [img.stem.replace("_", " ").title() for img in images]
```

### Selection Callback
When user selects new scene:
1. Get image path from scene name
2. Extract colors (static or palette for animation)
3. Apply to configured light(s)
4. Update entity state

## Services Provided

```yaml
chameleon.apply_scene:
  description: Apply colors from image to lights
  fields:
    entity_id: Light entity or entities
    scene_name: Scene name from dropdown
    mode: static or animated

chameleon.start_animation:
  description: Start color animation for lights
  fields:
    entity_id: Light entity or entities
    scene_name: Scene to animate

chameleon.stop_animation:
  description: Stop color animation
  fields:
    entity_id: Light entity or entities
```

## Animation Implementation

### Requirements
- Non-blocking async loop
- Configurable speed (seconds per color change)
- Graceful start/stop
- Multiple simultaneous animations (different lights)

### Database Considerations
**Critical**: Animation creates frequent state changes.

**Solutions Implemented**:
1. **Document recorder exclusion** in README
2. **Use transitions**: One state change per transition, not per color
3. **Default 5-10s interval**: Not too fast (86k writes/day at 1s interval)
4. **Configurable speed**: User can slow down if needed

**DO NOT**: Update light state every second without transitions.

## Configuration Flow

### Setup Steps
1. User adds integration via UI (Configuration → Integrations)
2. Config flow asks:
   - Light entity to control
   - Animation mode enabled? (toggle)
   - Animation speed (if enabled)
3. Integration creates select entity
4. Integration scans image directory for initial options
5. User can now select scenes from dropdown

### Multiple Instances
- User can add integration multiple times
- One instance per light (or per group of lights)
- Each instance creates its own select entity

## Testing

### Local Testing with Dummy Lights
```yaml
# ha-dev-config/configuration.yaml
light:
  - platform: template
    lights:
      test_theatre:
        friendly_name: "Test Theatre Accents"
        turn_on:
        turn_off:
        set_rgb:
          service: light.turn_on
          data:
            rgb_color: "{{ rgb_color }}"
```

### Production Testing
- Test with real Philips Hue or RGB lights
- Verify color accuracy
- Test animation smoothness
- Monitor DB writes (check recorder size growth)

## Common Issues

### Image Directory Not Found
- Ensure `/config/www/chameleon/` exists
- Integration should create it on first setup if missing

### Colors Look Wrong
- Check image format (RGB vs RGBA)
- Verify color space conversions
- Test with known-good images first

### Animation Kills SD Card
- User needs to add recorder exclusion
- Lower animation frequency
- Use longer transitions

### Select Entity Not Showing Options
- Check image directory scan logic
- Verify file extensions (jpg, png)
- Check logs for errors

## Deployment

### Development Version (rsync)
```bash
# Quick deploy to production for testing
rsync -avz --delete \
  custom_components/chameleon/ \
  homelab:/config/custom_components/chameleon/
ssh homelab "docker restart homeassistant"
```

### Release Version (HACS)
1. Tag release: `git tag v0.1.0`
2. Push to GitHub: `git push origin v0.1.0`
3. Users install via HACS custom repository
4. Or submit to HACS default repository (after stability)

## Code Style

- Follow Home Assistant development guidelines
- Use async/await for all I/O operations
- Type hints required
- Black formatter
- isort for imports
- Comprehensive docstrings

## Resources

- [HA Developer Docs](https://developers.home-assistant.io/)
- [Select Entity Platform](https://developers.home-assistant.io/docs/core/entity/select)
- [Config Flow](https://developers.home-assistant.io/docs/config_entries_config_flow_handler)
- [Adaptive Lighting Source](https://github.com/basnijholt/adaptive-lighting) - Reference implementation
- [Scenery Source](https://github.com/j9brown/scenery) - Reference for select entities

## Development Phases

### Phase 1: Core Static Mode (MVP)
- [x] Project structure
- [ ] Manifest and basic setup
- [ ] Config flow for single light
- [ ] Select entity creation
- [ ] Image directory scanning
- [ ] Color extraction (single dominant color)
- [ ] Apply color to light
- [ ] Basic testing

### Phase 2: Animation Mode
- [ ] Color palette extraction
- [ ] Gradient path generation
- [ ] Async animation loop
- [ ] Start/stop animation services
- [ ] Animation speed configuration

### Phase 3: Multi-Light Support
- [ ] Configure multiple lights in one instance
- [ ] Color distribution across lights
- [ ] Synchronized animation option
- [ ] Spatial color assignment

### Phase 4: Polish & Release
- [ ] Comprehensive documentation
- [ ] Example images included
- [ ] HACS metadata
- [ ] README with setup instructions
- [ ] Screenshots and demos
- [ ] Submit to HACS default repo

## Notes for Claude Code

When working on this project:
- Prioritize code quality and HA best practices
- Focus on user experience (simple setup, auto-discovery)
- Be mindful of database writes (animation impact)
- Test locally before deploying to production
- Keep file structure clean and modular
- Document complex color extraction logic
- Use descriptive variable names
- Add type hints everywhere
